from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.gridlayout import GridLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.core.window import Window



# Optional: nicer default window size on desktop (ignored on Android)
Window.size = (360, 640)


class CalculatorUI(BoxLayout):
    """
    This code handles what the user sees on the calculator:
    - shows the history (history)
    - shows the main display of the calculator
    """

    def __init__(self, **kwargs):
        super().__init__(orientation="vertical", size_hint_y=None, height=150, spacing=6, **kwargs)

        """
        #This code is the history that is displayed
        """

        self.history = Label(
            text="",
            font_size=18,
            halign="right",
            size_hint_y=None,
            height=40,
        )
        #This code prevents users from typing directly 
        self.main = TextInput(
            text="0",
            font_size=48,
            readonly=True,
            halign="right",
            multiline=False,
            size_hint_y=None,
            height=100,
        )

        self.add_widget(self.history)
        self.add_widget(self.main)

    def set_history(self, text: str):
        self.history.text = text

    def set_main(self, text: str):
        self.main.text = text

    def get_main(self) -> str:
        return self.main.text




class AndroidCalculator(BoxLayout):
    """
    This code will handle ALL of the calculator arithemtic logic.
    -Handles when the user presses the buttons
    -Builds arithemtic expressions
    -Evaluates arithmetic
    -Handles error managament
    """
    #

    def __init__(self, **kwargs):
        super().__init__(orientation="vertical", padding=12, spacing=10, **kwargs)

        self.display = CalculatorUI()
        self.add_widget(self.display)

        # Controls whether typing a digit starts a new number after "="
        self.just_evaluated = False

        #This code tests the memory behavior when a user presses the "=" button
        self.last_op = None
        self.last_rhs = None

        self.grid = GridLayout(cols=4, spacing=8)

        #Establish AC vs C functions 
        #AC = All clear and C = clear, which will clear the last number the user types
        self.clear_btn = self._button("AC", self.clear)
        """
        # This code contains the calculator buttons that the user presses
        """
        buttons = [
            self.clear_btn, self._button("⌫", self.backspace), self._button("±", self.toggle_sign), self._button("/", self.add_operator),
            self._button("7", self.add_digit), self._button("8", self.add_digit), self._button("9", self.add_digit), self._button("*", self.add_operator),
            self._button("4", self.add_digit), self._button("5", self.add_digit), self._button("6", self.add_digit), self._button("-", self.add_operator),
            self._button("1", self.add_digit), self._button("2", self.add_digit), self._button("3", self.add_digit), self._button("+", self.add_operator),
            self._button("0", self.add_digit), self._button(".", self.add_decimal), self._button("=", self.evaluate), self._button("%", self.percent),
        ]

        for b in buttons:
            self.grid.add_widget(b)

        self.add_widget(self.grid)

    # ---------------- This code contains the Button Factory ----------------
    #Every button has the same size font and will bind to a handler
    #Changing button styles will affect every button on the calculator 

    def _button(self, text, handler):
        btn = Button(text=text, font_size=28)
        btn.bind(on_press=handler)
        return btn

    # ---------------- UI Helpers ----------------
    def _update_clear_label(self):

        """
        AC will be shown when the display == "0
        C will be shown when the display doesn't equal 0
        """
        self.clear_btn.text = "AC" if self.display.get_main() == "0" else "C"

    # ---------------- This code is contains the Input Handlers ----------------
    def add_digit(self, btn):
        """
        This code test the numeric input:
        -Concatenates digits 
        -Removes leading zeros
        -If a user presses "=", then a digits starts a NEW entry
        """

        value = btn.text
        current = self.display.get_main()
        #resets after the evaluation
        if self.just_evaluated:
            self.display.set_main(value)
            self.display.set_history("")
            self.just_evaluated = False
        else:
            #leading zero exception
            self.display.set_main(value if current == "0" else current + value)

        self._update_clear_label()

    def add_decimal(self, _):

        #This code contains the decimal validation 
        #it will allow only one decimal point on a current display string
        current = self.display.get_main()
        if "." not in current:
            self.display.set_main(current + ".")

    def add_operator(self, btn):
        """
        Operator handing
        -Replaces operator if user taps operators repeatedly
        """

        op = btn.text
        current = self.display.get_main()

        #trailing operator replacement
        if current[-1] in "+-*/":
            current = current[:-1]

        self.display.set_main(current + op)
        self.display.set_history(current + op)
        self.just_evaluated = False

    def toggle_sign(self, _):
        current = self.display.get_main()
        if current.startswith("-"):
            self.display.set_main(current[1:])
        else:
            self.display.set_main("-" + current)

    #deletes last character
    #if only one character remains, it will return to 0
    def backspace(self, _):
        current = self.display.get_main()
        self.display.set_main(current[:-1] if len(current) > 1 else "0")

    def clear(self, _):

        """
        This is the code for the "clear" behavior
        -It resets the main display to 0
        -It will clear the history
        -resets
        """
        self.display.set_main("0")
        self.display.set_history("")
        self.just_evaluated = False
        self._update_clear_label()

    # ---------------- This code is for the arithemtic Evaluation part of the calculator----------------
    def evaluate(self, _):
        expr = self.display.get_main()

        try:
            result = eval(expr, {"__builtins__": None}, {})
            self.display.set_history(expr)
            self.display.set_main(str(result))
            self.just_evaluated = True
        except:
            self.display.set_main("Error")

    def percent(self, _):

        """
        Percentages:
        -converts a number to percentage
        -error will display if a display is not a plain number 

    """
        try:
            value = float(self.display.get_main())
            self.display.set_main(str(value / 100))
        except:
            self.display.set_main("Error")


class AndroidCalculatorApp(App):
    def build(self):
        self.title = "Android Calculator"
        return AndroidCalculator()


if __name__ == "__main__":
    AndroidCalculatorApp().run()